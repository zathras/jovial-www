<HTML>
<HEAD>
<TITLE>
Heap Analysis Tool (HAT)
</TITLE>
</HEAD>
<BODY BGCOLOR="#ffffff">
<FONT SIZE="+1"><STRONG>Java<SUP><FONT SIZE=-2>TM</FONT></SUP> Heap Analysis Tool (HAT)</STRONG></FONT><br>

<p>
This debugging tool enables you to read and analyze the new
-Xhprof files that are generated by
JDK<SUP><FONT SIZE=-2>TM</FONT></SUP> 1.2 as of the Beta 3
release. The Heap Analysis Tool (HAT) helps to debug
unnecessary object retention (sometimes imprecisely called "memory
leaks") by providing a convenient means to browse the object
topology in a heap snapshot, which is generated by the Java VM.
HAT reads a hprof file, then sets itself up as a web
server--therefore allowing you to run queries agains a heap
dump contained within the hprof file.
</p>
<p>
Please do understand that this is a <strong>prototype.</strong>  I do not
consider HAT to be of production quality.  I think the UI is somewhat
clumsy and unpolished (OK, it's a quick and dirty hack :-)  More
seriously, HAT is fairly memory-intensive.  Expect HAT to require
three times more RAM than the program being debugged.  I can
think of solutions for this, but I'll leave that as an exercise for the tool
vendor -- I have a day job, too!  Despite these limitations, I hope you'll
find HAT useful.
</p>
<p>
Both source and a binary of HAT are available as part of an
on-line training book.  Check out
<a href="http://developer.java.sun.com/developer/onlineTraining/Programming/JDCBook/perf3.html#profile">Advanced
Programming Book's chapter on Profiling</a>.  If that doesn't work,
it should be available on this
<a href="http://developer.java.sun.com/developer/products/j2ee/resources.html">J2EE resources page</a>.  If that fails, I made copies here of the
<a href="hat_bin.zip">Binary</a> or the <a href="hat_src.zip">Source</a>.
</p>
<h2>
<font color="red">IMPORTANT NOTE:</font>
</h2>
<p>
The heap profile file that you give to hat must be in <strong>binary</strong>
format.  This is done withe the &quot;format=b&quot; modifier to the
-Xhprof command line.  For example, to run the program Main, this command
will work:
</p>
<pre>
    java -Xhprof:file=dump.hprof,format=b Main
</pre>

<h2>
Dump Generator Program
</h2>
<p>
One feature of the JVM<B>*</B> is that you can request a heap dump over a socket.
This can be useful for remote debugging of devices that don't have file
systems, for example.  To use this feature, you run a program that listens
on a port on some machine (call it port 7001 on &quot;fido&quot;), and 
then you invoke the JVM like this:
</p>
<pre>

    java -Xhprof:net=fido:7001,format=b

</pre>
<p>
The JVM then connects to port 7001 on fido, and that program can send it a
command to generate a heap dump.
</p>
<p>
I wrote a quick hack to request these dumps.  It's called NetDumper, and
you can <a href="NetDumper.java">download it here.</a>
</p>

<h2>
Known Bugs
</h2>

<h4>
September, 2002:  Various releases
</h4>
<p>
I get occasional reports of errors reading .hprof files generated
with 1.3 and 1.4 VMs.  Usually, it's an IOException, with a message
about "Stack trace not found ...".
</p><p>
This is the result of a bug in the VM:  It is generating an improperly
formatted .hprof file.  To work around the problem, there are some 
command-line options you can provide to the VM generating the file
that may help.  I'm told the "-classic" option often results in a 
well-formatted .hprof file.  Setting "-stack=false" seems to be 
necessary, at least with some JDK releases.
</p><p>
If these fail, try a different JDK release, or a different
platform -- results are often different between Solaris and Win32,
for example.
</p>

<h4>
January, 1999:  Solaris<SUP><FONT SIZE=-2>TM</FONT></SUP> Production Release
</h4>
<p>
I have received reports that the JDK 1.2 Solaris Production Release does
not have a way of adding a heap dump to a .hprof file.  On the JDK Win32
Production Release this is done with ctrl-break; on the JDK Solaris 
Reference Implementation this is done with ctrl-backslash.  This is a known
bug, and has been submitted as bug number 4204089.
</p><p>
One possible workaround is to use the dump generator program, described
above.  Unfortunately, I've received a report that this results in a
segmentation fault in the target VM, at least under Solaris x86.  This
has been submitted as bug number 4204501.
</p><p>
Some versions of the production VM had a problem with the contents
of the heap dump.  This was submitted as bug number 4213660, and is marked
as fixed.  I'm not sure if the fix has been released at this time.  A
similar bug in the production VM is bug 4225829.  As of this writing
(April 8, 1999) this bug has not been fixed.
</p><p>
The JDK Solaris Reference Implementation (JDK 1.2) does not appear to
share these problems.  It is available for both Sparc Solaris and x86 Solaris,
and can be downloaded from 
<a href="http://java.sun.com/products/">http://java.sun.com/products/</a>.
</p>

<h4>
April 1998:  JDK 1.2beta3 Under Win32
</h4>
<p>
There is a bug in the Win32 version of JDK 1.2beta3 that causes it to
output corrupt .hprof files.  This has been fixed in 1.2beta4.  If
you're still using 1.2beta3, You can read more about it and download
a workaround <a href="workaround.html">here</a>.
</p>
<P>
<B>*As used on this web site, the terms "Java virtual machine" or "JVM" mean a virtual machine for the Java platform.</B>
</P>

</body>
</html>
